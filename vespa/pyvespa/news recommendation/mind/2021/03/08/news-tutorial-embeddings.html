<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Build a News recommendation app from python with Vespa | Thiago G. Martins</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Build a News recommendation app from python with Vespa" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Part 2 - From news search to news recommendation with embeddings" />
<meta property="og:description" content="Part 2 - From news search to news recommendation with embeddings" />
<link rel="canonical" href="https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html" />
<meta property="og:url" content="https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html" />
<meta property="og:site_name" content="Thiago G. Martins" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-08T00:00:00-06:00" />
<script type="application/ld+json">
{"description":"Part 2 - From news search to news recommendation with embeddings","mainEntityOfPage":{"@type":"WebPage","@id":"https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html"},"@type":"BlogPosting","url":"https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html","headline":"Build a News recommendation app from python with Vespa","dateModified":"2021-03-08T00:00:00-06:00","datePublished":"2021-03-08T00:00:00-06:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://thigm85.github.io/blog/feed.xml" title="Thiago G. Martins" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-28943273-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Build a News recommendation app from python with Vespa | Thiago G. Martins</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Build a News recommendation app from python with Vespa" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Part 2 - From news search to news recommendation with embeddings" />
<meta property="og:description" content="Part 2 - From news search to news recommendation with embeddings" />
<link rel="canonical" href="https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html" />
<meta property="og:url" content="https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html" />
<meta property="og:site_name" content="Thiago G. Martins" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-08T00:00:00-06:00" />
<script type="application/ld+json">
{"description":"Part 2 - From news search to news recommendation with embeddings","mainEntityOfPage":{"@type":"WebPage","@id":"https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html"},"@type":"BlogPosting","url":"https://thigm85.github.io/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html","headline":"Build a News recommendation app from python with Vespa","dateModified":"2021-03-08T00:00:00-06:00","datePublished":"2021-03-08T00:00:00-06:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://thigm85.github.io/blog/feed.xml" title="Thiago G. Martins" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-28943273-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script type="text/javascript">
require.config({
  paths: {
    jquery: 'https://code.jquery.com/jquery-3.5.0.min',
    plotly: 'https://cdn.plot.ly/plotly-latest.min'
  },

  shim: {
    plotly: {
      deps: ['jquery'],
      exports: 'plotly'
    }
  }
});
</script>

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Thiago G. Martins</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Build a News recommendation app from python with Vespa</h1><p class="page-description">Part 2 - From news search to news recommendation with embeddings</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-03-08T00:00:00-06:00" itemprop="datePublished">
        Mar 8, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#vespa">vespa</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#pyvespa">pyvespa</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#news recommendation">news recommendation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#MIND">MIND</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Add-a-user-schema">Add a user schema </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Index-news-embeddings">Index news embeddings </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Recommendation-using-embeddings">Recommendation using embeddings </a></li>
<li class="toc-entry toc-h2"><a href="#Query-Profile-Type">Query Profile Type </a></li>
<li class="toc-entry toc-h2"><a href="#Redeploy-the-application">Redeploy the application </a></li>
<li class="toc-entry toc-h2"><a href="#Feeding-and-partial-updates:-news-and-user-embeddings">Feeding and partial updates: news and user embeddings </a></li>
<li class="toc-entry toc-h2"><a href="#Fetch-the-user-embedding">Fetch the user embedding </a></li>
<li class="toc-entry toc-h2"><a href="#Get-recommendations">Get recommendations </a>
<ul>
<li class="toc-entry toc-h3"><a href="#ANN-search">ANN search </a></li>
<li class="toc-entry toc-h3"><a href="#Combine-ANN-search-with-query-filters">Combine ANN search with query filters </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-03-08-news-tutorial-embeddings.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this part, we'll start transforming our application from news search to news recommendation using the embeddings created in <a href="https://docs.vespa.ai/en/tutorials/news-4-embeddings.html">this tutorial</a>. An embedding vector will represent each user and news article. We will make the embeddings used available for download to make it easier to follow this post along. When a user comes, we retrieve his embedding and use it to retrieve the closest news articles via an approximate nearest neighbor (ANN) search. We also show that Vespa can jointly apply general filtering and ANN search, unlike competing alternatives available in the market.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We assume that you have followed <a href="https://blog.vespa.ai/build-news-search-app-from-python-with-vespa/">the news search tutorial</a>. Therefore, you should have an <code>app_package</code> variable holding the news search app definition and a Docker container named <code>news</code> running a search application fed with news articles from the demo version of the MIND dataset.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Add-a-user-schema">
<a class="anchor" href="#Add-a-user-schema" aria-hidden="true"><span class="octicon octicon-link"></span></a>Add a user schema<a class="anchor-link" href="#Add-a-user-schema"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We need to add another document type to represent a user. We set up the schema to search for a <code>user_id</code> and retrieve the user’s embedding vector.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">vespa.package</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">Document</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">app_package</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span>
    <span class="n">Schema</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"user"</span><span class="p">,</span> 
        <span class="n">document</span><span class="o">=</span><span class="n">Document</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="n">Field</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">"user_id"</span><span class="p">,</span> 
                    <span class="nb">type</span><span class="o">=</span><span class="s2">"string"</span><span class="p">,</span> 
                    <span class="n">indexing</span><span class="o">=</span><span class="p">[</span><span class="s2">"summary"</span><span class="p">,</span> <span class="s2">"attribute"</span><span class="p">],</span> 
                    <span class="n">attribute</span><span class="o">=</span><span class="p">[</span><span class="s2">"fast-search"</span><span class="p">]</span>
                <span class="p">),</span> 
                <span class="n">Field</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">"embedding"</span><span class="p">,</span> 
                    <span class="nb">type</span><span class="o">=</span><span class="s2">"tensor&lt;float&gt;(d0[51])"</span><span class="p">,</span> 
                    <span class="n">indexing</span><span class="o">=</span><span class="p">[</span><span class="s2">"summary"</span><span class="p">,</span> <span class="s2">"attribute"</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We build an index for the attribute field <code>user_id</code> by specifying the <code>fast-search</code> attribute. Remember that attribute fields are held in memory and are not indexed by default.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The embedding field is a tensor field. Tensors in Vespa are flexible multi-dimensional data structures and, as first-class citizens, can be used in queries, document fields, and constants in ranking. Tensors can be either dense or sparse or both and can contain any number of dimensions. Please see the <a href="https://docs.vespa.ai/en/tensor-user-guide.html">tensor user guide</a> for more information. Here we have defined a dense tensor with a single dimension (<code>d0</code> - dimension 0), representing a vector. 51 is the size of the embeddings used in this post.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We now have one schema for the <code>news</code> and one schema for the <code>user</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">app_package</span><span class="o">.</span><span class="n">schemas</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['news', 'user']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Index-news-embeddings">
<a class="anchor" href="#Index-news-embeddings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Index news embeddings<a class="anchor-link" href="#Index-news-embeddings"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Similarly to the user schema, we will use a dense tensor to represent the news embeddings. But unlike the user embedding field, we will index the news embedding by including <code>index</code> in the <code>indexing</code> argument and specify that we want to build the index using the HNSW (hierarchical navigable small world) algorithm. The distance metric used is euclidean. Read <a href="https://blog.vespa.ai/approximate-nearest-neighbor-search-in-vespa-part-1/">this blog post</a> to know more about Vespa’s journey to implement ANN search.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">vespa.package</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">HNSW</span>

<span class="n">app_package</span><span class="o">.</span><span class="n">get_schema</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"news"</span><span class="p">)</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span>
    <span class="n">Field</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"embedding"</span><span class="p">,</span> 
        <span class="nb">type</span><span class="o">=</span><span class="s2">"tensor&lt;float&gt;(d0[51])"</span><span class="p">,</span> 
        <span class="n">indexing</span><span class="o">=</span><span class="p">[</span><span class="s2">"attribute"</span><span class="p">,</span> <span class="s2">"index"</span><span class="p">],</span>
        <span class="n">ann</span><span class="o">=</span><span class="n">HNSW</span><span class="p">(</span><span class="n">distance_metric</span><span class="o">=</span><span class="s2">"euclidean"</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Recommendation-using-embeddings">
<a class="anchor" href="#Recommendation-using-embeddings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Recommendation using embeddings<a class="anchor-link" href="#Recommendation-using-embeddings"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here, we’ve added a ranking expression using the closeness ranking feature, which calculates the euclidean distance and uses that to rank the news articles. This rank-profile depends on using the nearestNeighbor search operator, which we’ll get back to below when searching. But for now, this expects a tensor in the query to use as the initial search point.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">vespa.package</span> <span class="kn">import</span> <span class="n">RankProfile</span>

<span class="n">app_package</span><span class="o">.</span><span class="n">get_schema</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"news"</span><span class="p">)</span><span class="o">.</span><span class="n">add_rank_profile</span><span class="p">(</span>
    <span class="n">RankProfile</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"recommendation"</span><span class="p">,</span> 
        <span class="n">inherits</span><span class="o">=</span><span class="s2">"default"</span><span class="p">,</span> 
        <span class="n">first_phase</span><span class="o">=</span><span class="s2">"closeness(field, embedding)"</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Query-Profile-Type">
<a class="anchor" href="#Query-Profile-Type" aria-hidden="true"><span class="octicon octicon-link"></span></a>Query Profile Type<a class="anchor-link" href="#Query-Profile-Type"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The recommendation rank profile above requires that we send a tensor along with the query. For Vespa to bind the correct types, it needs to know the expected type of this query parameter.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">vespa.package</span> <span class="kn">import</span> <span class="n">QueryTypeField</span>

<span class="n">app_package</span><span class="o">.</span><span class="n">query_profile_type</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span>
    <span class="n">QueryTypeField</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"ranking.features.query(user_embedding)"</span><span class="p">,</span> 
        <span class="nb">type</span><span class="o">=</span><span class="s2">"tensor&lt;float&gt;(d0[51])"</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This query profile type instructs Vespa to expect a float tensor with dimension <code>d0[51]</code> when the query parameter ranking.features.query(user_embedding) is passed. We’ll see how this works together with the nearestNeighbor search operator below.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Redeploy-the-application">
<a class="anchor" href="#Redeploy-the-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Redeploy the application<a class="anchor-link" href="#Redeploy-the-application"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We made all the required changes to turn our news search app into a news recommendation app. We can now redeploy the <code>app_package</code> to our running container named <code>news</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">vespa.package</span> <span class="kn">import</span> <span class="n">VespaDocker</span>

<span class="n">vespa_docker</span> <span class="o">=</span> <span class="n">VespaDocker</span><span class="o">.</span><span class="n">from_container_name_or_id</span><span class="p">(</span><span class="s2">"news"</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">vespa_docker</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">application_package</span><span class="o">=</span><span class="n">app_package</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Waiting for configuration server.
Waiting for configuration server.
Waiting for configuration server.
Waiting for configuration server.
Waiting for configuration server.
Finished deployment.
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">deployment_message</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>["Uploading application '/app/application' using http://localhost:19071/application/v2/tenant/default/session",
 "Session 7 for tenant 'default' created.",
 'Preparing session 7 using http://localhost:19071/application/v2/tenant/default/session/7/prepared',
 "WARNING: Host named 'news' may not receive any config since it is not a canonical hostname. Disregard this warning when testing in a Docker container.",
 "Session 7 for tenant 'default' prepared.",
 'Activating session 7 using http://localhost:19071/application/v2/tenant/default/session/7/active',
 "Session 7 for tenant 'default' activated.",
 'Checksum:   62d964000c4ff4a5280b342cd8d95c80',
 'Timestamp:  1616671116728',
 'Generation: 7',
 '']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Feeding-and-partial-updates:-news-and-user-embeddings">
<a class="anchor" href="#Feeding-and-partial-updates:-news-and-user-embeddings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Feeding and partial updates: news and user embeddings<a class="anchor-link" href="#Feeding-and-partial-updates:-news-and-user-embeddings"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To keep this tutorial easy to follow, we make the parsed embeddings available for download. To build them yourself, please follow <a href="https://docs.vespa.ai/en/tutorials/news-4-embeddings.html">this tutorial</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">json</span>

<span class="n">user_embeddings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"https://thigm85.github.io/data/mind/mind_demo_user_embeddings_parsed.json"</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
<span class="p">)</span>
<span class="n">news_embeddings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"https://thigm85.github.io/data/mind/mind_demo_news_embeddings_parsed.json"</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We just created the <code>user</code> schema, so we need to feed user data for the first time.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">user_embedding</span> <span class="ow">in</span> <span class="n">user_embeddings</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">feed_data_point</span><span class="p">(</span>
        <span class="n">schema</span><span class="o">=</span><span class="s2">"user"</span><span class="p">,</span> 
        <span class="n">data_id</span><span class="o">=</span><span class="n">user_embedding</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">],</span> 
        <span class="n">fields</span><span class="o">=</span><span class="n">user_embedding</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the news documents, we just need to update the <code>embedding</code> field added to the <code>news</code> schema.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">news_embedding</span> <span class="ow">in</span> <span class="n">news_embeddings</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span>
        <span class="n">schema</span><span class="o">=</span><span class="s2">"news"</span><span class="p">,</span> 
        <span class="n">data_id</span><span class="o">=</span><span class="n">news_embedding</span><span class="p">[</span><span class="s2">"news_id"</span><span class="p">],</span> 
        <span class="n">fields</span><span class="o">=</span><span class="p">{</span><span class="s2">"embedding"</span><span class="p">:</span> <span class="n">news_embedding</span><span class="p">[</span><span class="s2">"embedding"</span><span class="p">]}</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fetch-the-user-embedding">
<a class="anchor" href="#Fetch-the-user-embedding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fetch the user embedding<a class="anchor-link" href="#Fetch-the-user-embedding"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we create a <code>query_user_embedding</code> function to retrieve the user <code>embedding</code> by the <code>user_id</code>. Of course, you could do this more efficiently using a Vespa Searcher as described <a href="https://docs.vespa.ai/en/tutorials/news-6-recommendation-with-searchers.html">here</a>, but keeping everything in python at this point makes learning easier.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_embedding</span><span class="p">(</span><span class="n">hit_json</span><span class="p">):</span>
    <span class="n">embedding_json</span> <span class="o">=</span> <span class="n">hit_json</span><span class="p">[</span><span class="s2">"fields"</span><span class="p">][</span><span class="s2">"embedding"</span><span class="p">][</span><span class="s2">"cells"</span><span class="p">]</span>
    <span class="n">embedding_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_json</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">embedding_json</span><span class="p">:</span>
        <span class="n">embedding_vector</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s2">"address"</span><span class="p">][</span><span class="s2">"d0"</span><span class="p">])]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">"value"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">embedding_vector</span>

<span class="k">def</span> <span class="nf">query_user_embedding</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s2">"yql"</span><span class="p">:</span> <span class="s2">"select * from sources user where user_id contains '</span><span class="si">{}</span><span class="s2">';"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">)})</span>
    <span class="n">embedding</span> <span class="o">=</span> <span class="n">parse_embedding</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">embedding</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The function will query Vespa, retrieve the embedding and parse it into a list of floats. Here are the first five elements of the user <code>U63195</code>'s embedding.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">query_user_embedding</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">"U63195"</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[0.0,
 -0.1694680005311966,
 -0.0703359991312027,
 -0.03539799898862839,
 0.14579899609088898]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Get-recommendations">
<a class="anchor" href="#Get-recommendations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get recommendations<a class="anchor-link" href="#Get-recommendations"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ANN-search">
<a class="anchor" href="#ANN-search" aria-hidden="true"><span class="octicon octicon-link"></span></a>ANN search<a class="anchor-link" href="#ANN-search"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following <code>yql</code> instructs Vespa to select the <code>title</code> and the <code>category</code> from the ten news documents closest to the user embedding.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">yql</span> <span class="o">=</span> <span class="s2">"select title, category from sources news where ([{'targetHits': 10}]nearestNeighbor(embedding, user_embedding));"</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We also specify that we want to rank those documents by the <code>recommendation</code> rank-profile that we defined earlier and send the user embedding via the query profile type <code>ranking.features.query(user_embedding)</code> that we also defined in our <code>app_package</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="n">body</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"yql"</span><span class="p">:</span> <span class="n">yql</span><span class="p">,</span>        
        <span class="s2">"hits"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">"ranking.features.query(user_embedding)"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">query_user_embedding</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">"U63195"</span><span class="p">)),</span>
        <span class="s2">"ranking.profile"</span><span class="p">:</span> <span class="s2">"recommendation"</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here are the first two hits out of the ten returned.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{'id': 'index:news_content/0/aca03f4ba2274dd95b58db9a',
  'relevance': 0.1460561756063909,
  'source': 'news_content',
  'fields': {'category': 'music',
   'title': 'Broadway Star Laurel Griggs Suffered Asthma Attack Before She Died at Age 13'}},
 {'id': 'index:news_content/0/bd02238644c604f3a2d53364',
  'relevance': 0.14591827245062294,
  'source': 'news_content',
  'fields': {'category': 'tv',
   'title': "Rip Taylor's Cause of Death Revealed, Memorial Service Scheduled for Later This Month"}}]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Combine-ANN-search-with-query-filters">
<a class="anchor" href="#Combine-ANN-search-with-query-filters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Combine ANN search with query filters<a class="anchor-link" href="#Combine-ANN-search-with-query-filters"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vespa ANN search is fully integrated into the Vespa query tree. This integration means that we can include query filters and the ANN search will be applied only to documents that satisfy the filters. No need to do pre- or post-processing involving filters.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following <code>yql</code>  search over news documents that have <code>sports</code> as their category.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">yql</span> <span class="o">=</span> <span class="s2">"select title, category from sources news where "</span> \
      <span class="s2">"([{'targetHits': 10}]nearestNeighbor(embedding, user_embedding)) AND "</span> \
      <span class="s2">"category contains 'sports';"</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="n">body</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"yql"</span><span class="p">:</span> <span class="n">yql</span><span class="p">,</span>        
        <span class="s2">"hits"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">"ranking.features.query(user_embedding)"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">query_user_embedding</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">"U63195"</span><span class="p">)),</span>
        <span class="s2">"ranking.profile"</span><span class="p">:</span> <span class="s2">"recommendation"</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here are the first two hits out of the ten returned. Notice the <code>category</code> field.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{'id': 'index:news_content/0/375ea340c21b3138fae1a05c',
  'relevance': 0.14417346200569972,
  'source': 'news_content',
  'fields': {'category': 'sports',
   'title': 'Charles Rogers, former Michigan State football, Detroit Lions star, dead at 38'}},
 {'id': 'index:news_content/0/2b892989020ddf7796dae435',
  'relevance': 0.14404365847394848,
  'source': 'news_content',
  'fields': {'category': 'sports',
   'title': "'Monday Night Football' commentator under fire after belittling criticism of 49ers kicker for missed field goal"}}]</pre>
</div>

</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="thigm85/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/vespa/pyvespa/news%20recommendation/mind/2021/03/08/news-tutorial-embeddings.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Personal blog.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/thigm85" title="thigm85"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/Thiagogm" title="Thiagogm"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
