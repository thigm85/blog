<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Fine-tuning a BERT model for search applications | Thiago G. Martins</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Fine-tuning a BERT model for search applications" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Create training and serving compatible encodings, custom dataset and a basic setup based on the Transformers library." />
<meta property="og:description" content="Create training and serving compatible encodings, custom dataset and a basic setup based on the Transformers library." />
<link rel="canonical" href="https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html" />
<meta property="og:url" content="https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html" />
<meta property="og:site_name" content="Thiago G. Martins" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-29T00:00:00-05:00" />
<script type="application/ld+json">
{"dateModified":"2020-10-29T00:00:00-05:00","datePublished":"2020-10-29T00:00:00-05:00","description":"Create training and serving compatible encodings, custom dataset and a basic setup based on the Transformers library.","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html"},"url":"https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html","headline":"Fine-tuning a BERT model for search applications","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://thigm85.github.io/blog/feed.xml" title="Thiago G. Martins" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-28943273-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Fine-tuning a BERT model for search applications | Thiago G. Martins</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Fine-tuning a BERT model for search applications" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Create training and serving compatible encodings, custom dataset and a basic setup based on the Transformers library." />
<meta property="og:description" content="Create training and serving compatible encodings, custom dataset and a basic setup based on the Transformers library." />
<link rel="canonical" href="https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html" />
<meta property="og:url" content="https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html" />
<meta property="og:site_name" content="Thiago G. Martins" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-29T00:00:00-05:00" />
<script type="application/ld+json">
{"dateModified":"2020-10-29T00:00:00-05:00","datePublished":"2020-10-29T00:00:00-05:00","description":"Create training and serving compatible encodings, custom dataset and a basic setup based on the Transformers library.","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html"},"url":"https://thigm85.github.io/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html","headline":"Fine-tuning a BERT model for search applications","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://thigm85.github.io/blog/feed.xml" title="Thiago G. Martins" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-28943273-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script type="text/javascript">
require.config({
  paths: {
    jquery: 'https://code.jquery.com/jquery-3.5.0.min',
    plotly: 'https://cdn.plot.ly/plotly-latest.min'
  },

  shim: {
    plotly: {
      deps: ['jquery'],
      exports: 'plotly'
    }
  }
});
</script>

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Thiago G. Martins</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Fine-tuning a BERT model for search applications</h1><p class="page-description">Create training and serving compatible encodings, custom dataset and a basic setup based on the Transformers library.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-10-29T00:00:00-05:00" itemprop="datePublished">
        Oct 29, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#search">search</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#cord19">cord19</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#BERT">BERT</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#transformers">transformers</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/thigm85/blog/tree/master/_notebooks/2020-10-29-fine-tune-bert-search-basic.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          <div class="px-2">
    <a href="https://colab.research.google.com/github/thigm85/blog/blob/master/_notebooks/2020-10-29-fine-tune-bert-search-basic.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h3"><a href="#Load-the-dataset">Load the dataset </a></li>
<li class="toc-entry toc-h3"><a href="#Compatible-BERT-encodings">Compatible BERT encodings </a></li>
<li class="toc-entry toc-h3"><a href="#Create-Datasets">Create Datasets </a></li>
<li class="toc-entry toc-h3"><a href="#Fine-tune-the-BERT-model">Fine-tune the BERT model </a></li>
<li class="toc-entry toc-h3"><a href="#Export-the-model-to-onnx">Export the model to onnx </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-10-29-fine-tune-bert-search-basic.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-the-dataset">
<a class="anchor" href="#Load-the-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Load the dataset<a class="anchor-link" href="#Load-the-dataset"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to fine-tune the BERT models for the cord19 application we need to generate a set of query-document features as well as labels that indicate which documents are relevant for the specific queries. For this exercise we will use the <code>query</code> string to represent the query and the <code>title</code> string to represent the documents.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The file <code>labelled_data.json</code> contains information about the <code>query</code> string and the file <code>training_all_judgement_data.csv</code> contain information about labels and <code>title</code> string. Those files were created and covered elsewhere but you can download them <a href="https://drive.google.com/file/d/1R2hZTF6QBKPMaiuS4Du6aXQlBVnfZOAA/view?usp=sharing">here</a> and <a href="https://drive.google.com/file/d/18jNRM7G7agbO1Mg9t0l1pvqsz-qwEXpz/view?usp=sharing">here</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>

<span class="n">labelled_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"labelled_data_all.json"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">))</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="s2">"training_all_jugdments_data.csv"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>training_data</code> has almost everything we need, except the <code>query</code> string.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">training_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>document_id</th>
      <th>query_id</th>
      <th>label</th>
      <th>title-full</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>005b2j4b</td>
      <td>1</td>
      <td>2</td>
      <td>Monophyletic Relationship between Severe Acute...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>00fmeepz</td>
      <td>1</td>
      <td>1</td>
      <td>Comprehensive overview of COVID-19 based on cu...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>010vptx3</td>
      <td>1</td>
      <td>2</td>
      <td>The SARS, MERS and novel coronavirus (COVID-19...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0194oljo</td>
      <td>1</td>
      <td>1</td>
      <td>Evidence for zoonotic origins of Middle East r...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>021q9884</td>
      <td>1</td>
      <td>1</td>
      <td>Deadly virus effortlessly hops species</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The query string can be obtained from the <code>labelled_data</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">labelled_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"query_id"</span><span class="p">],</span> <span class="n">labelled_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"query"</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1 coronavirus origin
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Compatible-BERT-encodings">
<a class="anchor" href="#Compatible-BERT-encodings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compatible BERT encodings<a class="anchor-link" href="#Compatible-BERT-encodings"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since we are training a model that will be deployed in a search application, we need to ensure that the training encodings are compatible with encodings used at serving time. At serving time, document encodings will be applied offline when feeding the documents to the search engine while the query encoding will be applied at run-time upon arrival of the query. In addition, it might be relevant to use different maximum length for queries and documents.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">create_bert_encodings</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">query_input_size</span><span class="p">,</span> <span class="n">doc_input_size</span><span class="p">):</span>
    <span class="n">queries_encodings</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
        <span class="n">queries</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">query_input_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">docs_encodings</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
        <span class="n">docs</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">doc_input_size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    
    <span class="n">TOKEN_NONE</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">TOKEN_CLS</span><span class="o">=</span><span class="mi">101</span>
    <span class="n">TOKEN_SEP</span><span class="o">=</span><span class="mi">102</span>

    <span class="n">input_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">token_type_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">query_input_ids</span><span class="p">,</span> <span class="n">doc_input_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">queries_encodings</span><span class="p">[</span><span class="s2">"input_ids"</span><span class="p">],</span> <span class="n">docs_encodings</span><span class="p">[</span><span class="s2">"input_ids"</span><span class="p">]):</span>
        <span class="c1"># create input id</span>
        <span class="n">input_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">TOKEN_CLS</span><span class="p">]</span> <span class="o">+</span> <span class="n">query_input_ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">TOKEN_SEP</span><span class="p">]</span> <span class="o">+</span> <span class="n">doc_input_ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">TOKEN_SEP</span><span class="p">]</span>
        <span class="n">number_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_id</span><span class="p">)</span>
        <span class="n">padding_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">number_tokens</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">input_id</span> <span class="o">=</span> <span class="n">input_id</span> <span class="o">+</span> <span class="p">[</span><span class="n">TOKEN_NONE</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding_length</span>
        <span class="n">input_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_id</span><span class="p">)</span>
        <span class="c1"># create token id</span>
        <span class="n">token_type_id</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">([</span><span class="n">TOKEN_CLS</span><span class="p">]</span> <span class="o">+</span> <span class="n">query_input_ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">TOKEN_SEP</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_input_ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">TOKEN_SEP</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="n">TOKEN_NONE</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding_length</span>
        <span class="n">token_type_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_type_id</span><span class="p">)</span>
        <span class="c1"># create attention_mask</span>
        <span class="n">attention_mask</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_tokens</span> <span class="o">+</span> <span class="p">[</span><span class="n">TOKEN_NONE</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding_length</span><span class="p">)</span>

    <span class="n">encodings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"input_ids"</span><span class="p">:</span> <span class="n">input_ids</span><span class="p">,</span>
        <span class="s2">"token_type_ids"</span><span class="p">:</span> <span class="n">token_type_ids</span><span class="p">,</span>
        <span class="s2">"attention_mask"</span><span class="p">:</span> <span class="n">attention_mask</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">encodings</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-Datasets">
<a class="anchor" href="#Create-Datasets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create Datasets<a class="anchor-link" href="#Create-Datasets"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create a list for queries (represented by the query string), docs (represented by the doc titles) and labels from the <code>labelled_data</code> and <code>training_data</code> that we loaded earlier.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_queries</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_docs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">data_point</span> <span class="ow">in</span> <span class="n">labelled_data</span><span class="p">:</span>
    <span class="n">query_id</span> <span class="o">=</span> <span class="n">data_point</span><span class="p">[</span><span class="s2">"query_id"</span><span class="p">]</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="n">training_data</span><span class="p">[</span><span class="s2">"query_id"</span><span class="p">]</span> <span class="o">==</span> <span class="n">query_id</span><span class="p">][</span><span class="s2">"title-full"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">train_docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span>
    <span class="n">train_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">training_data</span><span class="p">[</span><span class="n">training_data</span><span class="p">[</span><span class="s2">"query_id"</span><span class="p">]</span> <span class="o">==</span> <span class="n">query_id</span><span class="p">][</span><span class="s2">"label"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">data_point</span><span class="p">[</span><span class="s2">"query"</span><span class="p">]</span>
    <span class="n">train_queries</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">query</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We are going to use a simple data split into train and validation sets for illustration purposes. The cord19 use case probably needs cross-validation to be used since it has only 50 queries containing relevance judgement.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">train_queries</span><span class="p">,</span> <span class="n">val_queries</span><span class="p">,</span> <span class="n">train_docs</span><span class="p">,</span> <span class="n">val_docs</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">val_labels</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">train_queries</span><span class="p">,</span> <span class="n">train_docs</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=.</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create train and validation encodings. In order to do that we need to chose which BERT model to use, and the maximum size used for the resulting query and document vector.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">"google/bert_uncased_L-4_H-512_A-8"</span>
<span class="n">query_input_size</span><span class="o">=</span><span class="mi">24</span>
<span class="n">doc_input_size</span><span class="o">=</span><span class="mi">64</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">BertTokenizerFast</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizerFast</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>

<span class="n">train_encodings</span> <span class="o">=</span> <span class="n">create_bert_encodings</span><span class="p">(</span>
    <span class="n">queries</span><span class="o">=</span><span class="n">train_queries</span><span class="p">,</span> 
    <span class="n">docs</span><span class="o">=</span><span class="n">train_docs</span><span class="p">,</span> 
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> 
    <span class="n">query_input_size</span><span class="o">=</span><span class="n">query_input_size</span><span class="p">,</span> 
    <span class="n">doc_input_size</span><span class="o">=</span><span class="n">doc_input_size</span>
<span class="p">)</span>

<span class="n">val_encodings</span> <span class="o">=</span> <span class="n">create_bert_encodings</span><span class="p">(</span>
    <span class="n">queries</span><span class="o">=</span><span class="n">val_queries</span><span class="p">,</span> 
    <span class="n">docs</span><span class="o">=</span><span class="n">val_docs</span><span class="p">,</span> 
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> 
    <span class="n">query_input_size</span><span class="o">=</span><span class="n">query_input_size</span><span class="p">,</span> 
    <span class="n">doc_input_size</span><span class="o">=</span><span class="n">doc_input_size</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have the encodings and the labels we can create a <code>Dataset</code> object as described in the transformers webpage about <a href="https://huggingface.co/transformers/custom_datasets.html">custom datasets</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="k">class</span> <span class="nc">Cord19Dataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encodings</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encodings</span> <span class="o">=</span> <span class="n">encodings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encodings</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">'labels'</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">item</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">Cord19Dataset</span><span class="p">(</span><span class="n">train_encodings</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">Cord19Dataset</span><span class="p">(</span><span class="n">val_encodings</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Fine-tune-the-BERT-model">
<a class="anchor" href="#Fine-tune-the-BERT-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fine-tune the BERT model<a class="anchor-link" href="#Fine-tune-the-BERT-model"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can then fine-tune the model (only task specific weights). Below is a basic routine with out-of-the-box set of parameters. Care should be taken when chosing the parameters below, but this is out of the scope of this piece.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">BertForSequenceClassification</span><span class="p">,</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">TrainingArguments</span>

<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="s1">'./results'</span><span class="p">,</span>          <span class="c1"># output directory</span>
    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>              <span class="c1"># total number of training epochs</span>
    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># batch size per device during training</span>
    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>   <span class="c1"># batch size for evaluation</span>
    <span class="n">warmup_steps</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>                <span class="c1"># number of warmup steps for learning rate scheduler</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>               <span class="c1"># strength of weight decay</span>
    <span class="n">logging_dir</span><span class="o">=</span><span class="s1">'./logs'</span><span class="p">,</span>            <span class="c1"># directory for storing logs</span>
    <span class="n">logging_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">BertForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
    <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>                         <span class="c1"># the instantiated ðŸ¤— Transformers model to be trained</span>
    <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>                  <span class="c1"># training arguments, defined above</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>         <span class="c1"># training dataset</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">val_dataset</span>             <span class="c1"># evaluation dataset</span>
<span class="p">)</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Export-the-model-to-onnx">
<a class="anchor" href="#Export-the-model-to-onnx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Export the model to onnx<a class="anchor-link" href="#Export-the-model-to-onnx"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once training is complete we can export the model using the <a href="https://onnx.ai/">ONNX</a> format.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.onnx</span> <span class="kn">import</span> <span class="n">export</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span> 

<span class="n">model_onnx_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">".onnx"</span><span class="p">)</span>
<span class="n">dummy_input</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"input_ids"</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> 
    <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"token_type_ids"</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> 
    <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"attention_mask"</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"input_ids"</span><span class="p">,</span> <span class="s2">"token_type_ids"</span><span class="p">,</span> <span class="s2">"attention_mask"</span><span class="p">]</span>
<span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"logits"</span><span class="p">]</span>
<span class="n">export</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">dummy_input</span><span class="p">,</span> <span class="n">model_onnx_path</span><span class="p">,</span> <span class="n">input_names</span> <span class="o">=</span> <span class="n">input_names</span><span class="p">,</span> 
    <span class="n">output_names</span> <span class="o">=</span> <span class="n">output_names</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opset_version</span><span class="o">=</span><span class="mi">11</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="thigm85/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/search/cord19/bert/transformers/2020/10/29/fine-tune-bert-search-basic.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Personal blog.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/thigm85" title="thigm85"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/Thiagogm" title="Thiagogm"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
